# 多模態 LLM OMR Prompt 草案（以 Gemini 類服務為例）

本檔範例說明如何對多模態 LLM 發出請求，將「四部和聲作業樂譜圖片」轉成結構化 JSON。  
實際部署時請依照使用的 API（例如 Gemini、其他 Vision 模型）調整格式。

---
## 1. 任務說明（概念）

目標：  
給模型一張四部和聲練習題的樂譜圖片，請模型讀出：

- 調號（例如 C major, g minor）  
- 拍號（例如 4/4, 3/4）  
- 每一小節、每一拍的和聲快照：
  - 每個聲部（S, A, T, B）的音高（例如 C4, F#3）  
  - 音符時值（以拍為單位）  
  - 小節與拍位置

最後必須輸出符合 docs/omr_proxy_api.md 中 Response JSON Schema 的結構。

---
## 2. 系統訊息（System Prompt 範例）

可在後端 proxy 中固定使用類似內容：

你是一位懂西洋傳統和聲學與樂譜閱讀的專家。  
你會收到一張四部和聲練習題的樂譜圖片，例如 SATB 合唱或鋼琴兩行縮寫。  
請你：

1. 仔細辨識每一小節與每一拍。  
2. 將每個聲部（S, A, T, B）的音高與時值完整輸出。  
3. 僅輸出 JSON，且必須符合事先提供的 JSON 結構。  
4. 若圖片有模糊處，仍要盡力推測，但不要捏造超出樂譜以外的資訊。  
5. 若無法辨識，請在 warnings 欄位中附上簡短說明。

---
## 3. 使用者訊息（User Prompt 範例）

以下是假設的 user prompt（文字部分），實際呼叫時會同時附上圖片：

請閱讀這張樂譜圖片。這是一題四部和聲作業，包含 S（Soprano）、A（Alto）、T（Tenor）、B（Bass）。

請根據圖片內容，輸出一個 JSON 物件，必須符合以下結構：

- measures: 小節陣列
  - index: 小節編號（從 1 開始）
  - time_signature: 拍號字串（例如 "4/4"）
  - key_signature: 調性字串（例如 "C major"）
  - chords: 此小節中所有和聲快照
    - beat: 此和弦在小節中的拍位置（例如 1.0, 1.5, 2.0）
    - notes: 音符陣列
      - voice: 聲部（"S", "A", "T", "B"）
      - pitch: 音高（如 "C4", "F#3"）
      - duration: 音符時值（以拍為單位，四分音符=1.0，八分音符=0.5）
      - tie: 連結音狀態（"NONE", "START", "STOP", "CONTINUE"）

請只輸出 JSON，不要包含解說文字。

---
## 4. 實際 API 呼叫時的注意事項

- 若使用 Gemini API：
  - 後端需先將圖片與文字 prompt 一起送出。  
  - 對模型強調「只輸出 JSON」與「遵守欄位名稱與型別」。

- 若模型偶爾輸出多餘文字：
  - 可以在後端加一層 post-processing，取出第一個 JSON 區塊並嘗試解析。

- 若辨識結果與實際樂譜有明顯差異：
  - 在 warnings 欄位記錄，方便未來 debug 或人工校正。

---
## 5. 未來可調整的方向

- 根據實際教材格式，加入更多提示（例如：是否固定終止式在最後兩小節、題號、調性已知等）。  
- 若作業格式固定，也可以事先告知模型例如「總共有 8 小節」，減少遺漏。  
- 如有需要，可另外請模型輸出 Roman Numeral 分析供對照，但不進入規則引擎。

此檔僅為草案，實作時可以多次迭代 prompt 文字，根據成果調整。
