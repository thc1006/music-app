# 四部和聲規則條文化整理（目前已實作部分）

> 本文件將目前程式中有實作的規則，整理成條文化說明，並標示對應的 `rule_id` 以及在 `HarmonyAnalyzer` 中的檢查函式名稱。  
> 條文內容主要根據你提供的《和聲學總論》《Harmony 筆記》《Cadence 範例》等筆記整合而成。

---

## 類別 A：聲部進行（橫向）

### A1. 旋律跳進限制（Melodic Leap Constraints）`rule_id="M1"`

- **中文說明**：任何聲部的旋律進行應以級進為主，避免大跳：
  - 一般情況下，不可使用超過八度的旋律跳進。
  - 不鼓勵使用七度跳進；若出現，必須有合理的「解決」。
  - 不可使用增四度／減五度等增減音程的旋律跳進。
  - 內聲部（Alto, Tenor）不應超過完全四度的跳進。
- **程式邏輯**：
  - 逐一檢查每個聲部相鄰兩音的半音距離：
    - 若絕對值 > 12 → 視為超過八度的跳進 → `severity="error"`。
    - 若絕對值等於 10 或 11（小／大七度）→ 標記為潛在問題 → `severity="warning"`。
    - 若絕對值等於 6（增四度／減五度）→ 視為禁用旋律音程 → `severity="error"`。
    - 對內聲部 A/T：若跳進絕對值 > 5（超過完全四度）→ `severity="error"`。
- **對應程式**：`HarmonyAnalyzer._check_melodic_intervals`。

---

### A2. 聲部交錯與超越（Crossing & Overlap）`rule_id="V1"`

- **中文說明**：四部和聲中，相鄰聲部之間應維持基本的高低層次關係：S > A > T > B。  
  - **交錯（Crossing）**：同一和弦中，低聲部的音高高於高聲部，例如 Alto 比 Soprano 高。  
  - **超越（Overlap）**：兩個相鄰和弦之間，後一和弦的下方聲部超過前一和弦上方聲部的音高，或反之。
- **程式邏輯**：
  - 每一個和弦：檢查 S/A/T/B 的音高是否違反 S ≥ A ≥ T ≥ B 的順序（同音允許）。
  - 相鄰兩和弦：檢查任一對相鄰聲部是否發生超越。
- **對應程式**：`HarmonyAnalyzer._check_voice_crossing_and_overlap`。

---

## 類別 B：聲部間關係（縱向）

### B1. 平行八度與平行五度（Parallel 8ves & 5ths）`rule_id="P1"`

- **中文說明**：任兩聲部由一個相距八度或五度的音程，同方向進行到另一個八度或五度，稱為「平行八度／平行五度」，在嚴格四部和聲中一律禁止。  
- **程式邏輯**：
  - 對所有聲部組合（S–A、S–T、S–B、A–T、A–B、T–B）計算相鄰和弦的音程：
    - 若前一和弦為八度／五度，且兩聲部同向移動，且下一和弦仍為八度／五度 → 視為平行八／五度。
    - 只要任一聲部有移動（不是純粹「持音」）即算犯規。
- **對應程式**：`HarmonyAnalyzer._check_parallel_intervals`。

---

### B2. 隱伏八度與隱伏五度（Hidden / Direct 8ves & 5ths）`rule_id="P2"`

- **中文說明**：二外聲部（Soprano 和 Bass）由非八度／五度的音程，同方向進行到八度或五度時，稱為「隱伏八度／五度」，多半不被鼓勵；但若 Soprano **級進**、Bass **跳進**，可視為可接受的例外。  
- **程式邏輯**：
  - 只檢查外聲部 S–B。
  - 若前一和弦 S–B 的音程非八度／五度，但下一和弦變成八度／五度，且 S、B 同向移動：
    - 若 S 是級進（1–2 個半音）且 B 為跳進（>2 個半音）→ 視為例外，標記為 `warning` 或略過。
    - 否則 → 視為隱伏八／五度 → `severity="error"`。
- **對應程式**：`HarmonyAnalyzer._check_hidden_intervals`。

---

## 類別 C：和弦結構與重複音

### C1. 三和弦的重複音與省略音（Triad Doubling & Omission）`rule_id="D1"`

- **中文說明**：在四部和聲的三和弦配置中：  
  - 以重複根音為主，重複五音次之。
  - 省略音僅可省略五音，不可省略根音與三音。
  - 若省略五音，則必須重複根音三次（「三根一三」）。
  - 七級和弦多用一轉，且重複三音，避免重複導音。
  - 增三和弦不使用二轉位。
- **程式邏輯**：
  - 嘗試從和弦音集合中推斷三和弦根音與品質（大、小、增、減）。
  - 若無法識別為標準三和弦 → 此規則跳過。
  - 檢查：
    - 是否少了根音或三音 → `severity="error"`。
    - 是否出現過多導音（若根音是導音且重複）→ `severity="error"`。
    - 若偵測為六四和弦（第二轉位）且非經過／持續／終止用途，僅做「必須重複五音」的結構檢查，邏輯一律視為「須重複低音」。
- **對應程式**：`HarmonyAnalyzer._check_triad_doubling`。

---

## 類別 D：導音解決與調性相關規則

### D1. 導音上行解決（Leading Tone Resolution）`rule_id="L1"`

- **中文說明**：在功能和聲中，導音（七級音）傾向向上半音解決到主音；尤其當導音出現在外聲部（Soprano 或 Bass）時，通常被視為強制要求。  
- **程式邏輯**：
  - 需要提供調性的主音（`KeySignature.tonic_midi` 與 `mode`）。
  - 對每一個和弦：
    - 尋找 S/B 聲部是否含有導音音高（相對於主音的半音為 −1 mod 12）。
    - 若有，檢查下一個和弦同一聲部：
      - 是否上行半音到主音 → 正常。
      - 若未解決（保持不動或改到其他音）→ `severity="error"`，並記錄為「導音未正確解決」。
- **對應程式**：`HarmonyAnalyzer._check_leading_tone_resolution`。

---

## 類別 E：終止式粗略分類（Cadence Classification）

> 目前程式中的終止式判斷是「分析工具」，不是「錯誤檢查」，因此不會產生 `RuleViolation`，而是回傳一個簡單的 `cadence_type` 字串，供 UI 或後續模組使用。

### E1. 完全正格終止（Perfect Authentic Cadence, PAC）

- **中文說明**：在主調中，和聲由 V 或 V7 解決到 I，且兩和弦為原位，最後一個和弦的 Soprano 停在主音。  
- **程式邏輯（簡化版）**：
  - 檢查最後兩個和弦的根音音級是否為 5 → 1。
  - 嘗試判斷是否為「原位」：以 Bass 音是否為根音作為近似判定。
  - 最後一和弦的 Soprano 是否為主音。
  - 若皆符合 → 回傳 `"PAC"`。

### E2. 不完全正格終止（Imperfect Authentic Cadence, IAC）

- **中文說明**：同樣是 V → I，但不符合 PAC 的一項或多項條件（例如 Soprano 非主音或有一個和弦非原位）。  
- **程式邏輯（簡化版）**：
  - 和弦根音為 5 → 1，但未達 PAC 條件 → `"IAC"`。

### E3. 正格半終止（Authentic Half Cadence, HC）

- **中文說明**：樂句停在 V 級和弦上，造成懸置感。  
- **程式邏輯（簡化版）**：
  - 最後一和弦根音音級為 5，且前一和弦並非典型 V（避免 V–V）→ `"HC"`。

### E4. 變格終止（Plagal Cadence, PC）

- **中文說明**：由 IV 解決到 I 的終止方式，常見於聖誕詩歌或宗教曲式。  
- **程式邏輯（簡化版）**：
  - 最後兩個和弦根音音級為 4 → 1 → `"PC"`。

### E5. 阻礙／虛偽終止（Deceptive Cadence, DC）

- **中文說明**：由 V 解決到 VI（或 vi），聽眾以為會回到 I，但實際落在 VI，產生「受阻」的效果。  
- **程式邏輯（簡化版）**：
  - 最後兩個和弦根音音級為 5 → 6 → `"DC"`。

---

## 後續可擴充的規則（尚未實作，但可在此文件持續增列）

- 聲部音域上／下限（例如 S: C4–G5 等）。
- 上三聲部之間不可超過八度的間距規則。
- 特定和弦（例如 vii°、增三和弦、各種七和弦）的用法與解析方向。
- 特殊經過和弦、裝飾和弦（例如 cadential 6/4 的處理方式）。

你接下來可以：

1. 在 `harmony_rules.py` 裡新增對應的檢查函式與 `rule_id`。
2. 回到本文件，把新的規則條文化並記錄「程式實作位置」。

這樣一來，整個規則庫就可以被視為一份「可機器執行的樂理講義」。