# barline_double æ”¹å–„æ–¹æ¡ˆ

**åˆ†ææ—¥æœŸ**: 2025-11-26
**ç•¶å‰ç‹€æ…‹**: Phase 6 è¨“ç·´å®Œæˆ
**å•é¡Œåš´é‡æ€§**: ğŸ”´ CRITICAL - æœ€å·®è¡¨ç¾é¡åˆ¥

---

## ğŸ“Š ç•¶å‰ç‹€æ³åˆ†æ

### Phase 6 è¨“ç·´çµæœ

| æŒ‡æ¨™ | Phase 5 | Phase 6 | æå‡ | ç›®æ¨™ | å·®è· |
|------|---------|---------|------|------|------|
| **mAP50** | 0.140 | **0.180** | +28.6% | 0.50+ | -63.9% |
| **å¬å›ç‡** | 13.3% | **19.2%** | +5.9pp | 50%+ | -30.8pp |
| **ç²¾ç¢ºç‡** | 34.5% | **42.1%** | +7.6pp | 70%+ | -27.9pp |
| **é©—è­‰å¯¦ä¾‹** | 173 | 224 | +51 | - | - |

**é—œéµç™¼ç¾**:
- âœ… Phase 6 æœ‰é€²æ­¥ï¼Œä½†**é æœªé”æ¨™**ï¼ˆmAP50 åƒ… 0.180ï¼‰
- âŒ **å¬å›ç‡ä»åªæœ‰ 19.2%**ï¼ˆæ¼æª¢ 80.8%ï¼‰
- âŒ ç²¾ç¢ºç‡ 42.1%ï¼ˆèª¤æª¢ç‡ 57.9%ï¼‰
- âš ï¸ åœ¨æ‰€æœ‰é¡åˆ¥ä¸­è¡¨ç¾**å€’æ•¸ç¬¬ä¸€**

### æ ¹æœ¬å•é¡Œåˆ†æï¼ˆä¾†è‡ª BARLINE_COMPLETE_ANALYSISï¼‰

| å•é¡Œ | çµ±è¨ˆæ•¸æ“š | å½±éŸ¿ |
|------|---------|------|
| **1. æ¨£æœ¬ç¨€å°‘** | åƒ… 1,883 å€‹æ¨™è¨»ï¼ˆæœ€å°‘çš„ barline é¡åˆ¥ï¼‰ | ğŸ”´ CRITICAL |
| **2. æ¨™è¨»æ¡†éå¤§** | 67.8% é¢ç© > 0.1ï¼ˆç•°å¸¸è†¨è„¹ï¼‰ | ğŸ”´ CRITICAL |
| **3. è¦–è¦ºç‰¹å¾µæ¨¡ç³Š** | æ¡†å¤ªå¤§å°è‡´ç‰¹å¾µä¸æ¸…æ™°ï¼ˆ2 æ ¹ç·š + ç©ºéš™ï¼‰ | ğŸ”´ CRITICAL |
| **4. æ•¸æ“šä¸å¹³è¡¡** | barline_final æœ‰ 58,819 å€‹ï¼ˆ31x moreï¼‰ | ğŸŸ¡ WARNING |

---

## ğŸ¯ æ”¹å–„ç­–ç•¥å„ªå…ˆç´šæ’åº

### æŠ•è³‡å ±é…¬æ¯”åˆ†æ

| æ–¹æ¡ˆ | æŠ•å…¥æ™‚é–“ | é æœŸæå‡ | æˆåŠŸç‡ | ROI | å„ªå…ˆç´š |
|------|---------|---------|--------|-----|--------|
| **æ–¹æ¡ˆ 1A: OpenScore Lieder æ¸²æŸ“** | 1-2 å¤© | mAP +0.10-0.15 | 90% | â­â­â­â­â­ | ğŸ”¥ **ç«‹å³åŸ·è¡Œ** |
| **æ–¹æ¡ˆ 1B: æ¨™è¨»ä¿®æ­£è…³æœ¬** | 4-6 å°æ™‚ | mAP +0.05-0.08 | 85% | â­â­â­â­â­ | ğŸ”¥ **ç«‹å³åŸ·è¡Œ** |
| **æ–¹æ¡ˆ 2: æ¿€é€²åŠ æ¬Šè¨“ç·´** | 8-12 å°æ™‚ | mAP +0.08-0.12 | 75% | â­â­â­â­ | ğŸŸ¢ **çŸ­æœŸ** |
| **æ–¹æ¡ˆ 3: åˆæˆæ•¸æ“šç”Ÿæˆ** | 1-2 é€± | mAP +0.15-0.20 | 70% | â­â­â­â­ | ğŸŸ¡ **ä¸­æœŸ** |
| **æ–¹æ¡ˆ 4: é¡åˆ¥åˆä½µ** | 2-3 å¤© | mAP +0.20+ | 60% | â­â­â­ | ğŸ”µ **å‚™é¸** |

---

## ğŸš€ æ–¹æ¡ˆ 1A: OpenScore Lieder æ¸²æŸ“ï¼ˆç«‹å³åŸ·è¡Œï¼‰

### ç‚ºä»€éº¼é€™æ˜¯æœ€ä½³æ–¹æ¡ˆï¼Ÿ

æ ¹æ“š `OPENSCORE_LIEDER_ANALYSIS.md`:

| æŒ‡æ¨™ | OpenScore Lieder | MUSCIMA++ | å€æ•¸ |
|------|------------------|-----------|------|
| **barline_double ä¾†æº** | **4,017 å€‹** | 42 | **95.6x** |
| **æ–‡ä»¶æ•¸** | 1,410 | 140 | 10.1x |
| **æˆæ¬Š** | CC-0ï¼ˆå•†ç”¨å¯ï¼‰ | CC-BY-NC-SA | âœ… |

**å…·é«”åˆ†ä½ˆ**:
- `light-heavy`: 3,554 å€‹ â†’ barline_final
- `heavy-light`: 463 å€‹ â†’ barline_double

### å¯¦æ–½æ­¥é©Ÿï¼ˆ1-2 å¤©ï¼‰

#### Day 1: ç’°å¢ƒè¨­ç½®èˆ‡æ¸¬è©¦æ¸²æŸ“ï¼ˆ4-6 å°æ™‚ï¼‰

```bash
# Step 1: å®‰è£ Verovioï¼ˆæ¨è–¦ï¼‰
cd /home/thc1006/dev/music-app/training
pip install verovio

# Step 2: æ¸¬è©¦æ¸²æŸ“å–®å€‹æ–‡ä»¶
python << 'EOF'
import verovio
from pathlib import Path

# è¼‰å…¥ Verovio toolkit
tk = verovio.toolkit()
tk.setOptions({
    "pageHeight": 2970,
    "pageWidth": 2100,
    "scale": 100,
    "adjustPageHeight": True
})

# æ¸¬è©¦æ¸²æŸ“
test_file = "datasets/external/omr_downloads/OpenScoreLieder/scores/Viardot,_Pauline/L'enfant_et_la_mere/L'enfant_et_la_mere.mxl"
tk.loadFile(test_file)

# æ¸²æŸ“ç‚º SVG
svg = tk.renderToSVG(1)
with open("test_openscore_render.svg", "w") as f:
    f.write(svg)

print("âœ… Test render successful")
EOF

# Step 3: è½‰æ› SVG â†’ PNG
pip install cairosvg
python << 'EOF'
import cairosvg

cairosvg.svg2png(
    url="test_openscore_render.svg",
    write_to="test_openscore_render.png",
    dpi=300
)
print("âœ… PNG conversion successful")
EOF
```

#### Day 1-2: æ‰¹é‡æ¸²æŸ“è…³æœ¬ï¼ˆ8-12 å°æ™‚ï¼‰

å‰µå»º `scripts/render_openscore_barlines.py`:

```python
"""
OpenScore Lieder Barline æ¸²æŸ“è…³æœ¬
å„ªå…ˆæ¸²æŸ“å« double/final barlines çš„æ–‡ä»¶
"""
import verovio
import cairosvg
from pathlib import Path
from xml.etree import ElementTree as ET
import json
from tqdm import tqdm
import multiprocessing as mp

class OpenScoreBarlineRenderer:
    def __init__(self, openscore_dir, output_dir):
        self.openscore_dir = Path(openscore_dir)
        self.output_dir = Path(output_dir)
        self.tk = verovio.toolkit()
        self.tk.setOptions({
            "pageHeight": 2970,
            "pageWidth": 2100,
            "scale": 100,
            "breaks": "none",  # é€£çºŒæ¸²æŸ“ä¸åˆ†é 
        })

    def parse_musicxml_barlines(self, mxl_path):
        """è§£æ MusicXML ä¸­çš„ barline é¡å‹"""
        tree = ET.parse(mxl_path)
        root = tree.getroot()

        barlines = []
        for barline in root.findall('.//barline'):
            bar_style = barline.find('bar-style')
            if bar_style is not None:
                style = bar_style.text
                location = barline.get('location', 'right')
                barlines.append({
                    'style': style,
                    'location': location
                })

        return barlines

    def has_target_barlines(self, mxl_path):
        """æª¢æŸ¥æ–‡ä»¶æ˜¯å¦å«æœ‰ double/final barlines"""
        barlines = self.parse_musicxml_barlines(mxl_path)
        target_styles = ['light-heavy', 'heavy-light', 'heavy-heavy']
        return any(b['style'] in target_styles for b in barlines)

    def render_file(self, mxl_path, output_name):
        """æ¸²æŸ“å–®å€‹æ–‡ä»¶åˆ° PNG"""
        # 1. è¼‰å…¥ MusicXML
        self.tk.loadFile(str(mxl_path))

        # 2. å–å¾—é æ•¸
        page_count = self.tk.getPageCount()

        images = []
        for page in range(1, page_count + 1):
            # 3. æ¸²æŸ“ SVG
            svg = self.tk.renderToSVG(page)

            # 4. è½‰æ›ç‚º PNG
            png_path = self.output_dir / "images" / f"{output_name}_page{page}.png"
            png_path.parent.mkdir(parents=True, exist_ok=True)

            cairosvg.svg2png(
                bytestring=svg.encode('utf-8'),
                write_to=str(png_path),
                dpi=300
            )

            images.append(png_path)

        return images

    def extract_barline_bboxes(self, mxl_path, svg_path):
        """
        å¾ SVG ä¸­æå– barline bounding boxes
        ä½¿ç”¨ Verovio çš„å…ƒç´  ID åŒ¹é…
        """
        # è§£æ SVG
        tree = ET.parse(svg_path)
        root = tree.getroot()

        # Verovio æœƒç”Ÿæˆå¸¶æœ‰ ID çš„ SVG å…ƒç´ 
        # æ ¼å¼: measure-1-barline-1
        bboxes = []

        for elem in root.iter():
            elem_id = elem.get('id', '')
            if 'barline' in elem_id:
                # å–å¾— bounding box
                x = float(elem.get('x', 0))
                y = float(elem.get('y', 0))
                width = float(elem.get('width', 0))
                height = float(elem.get('height', 0))

                # è½‰æ›ç‚º YOLO æ ¼å¼ (normalized)
                # éœ€è¦çŸ¥é“ SVG çš„ç¸½å¯¬é«˜
                svg_width = float(root.get('width', 2100))
                svg_height = float(root.get('height', 2970))

                x_center = (x + width / 2) / svg_width
                y_center = (y + height / 2) / svg_height
                norm_width = width / svg_width
                norm_height = height / svg_height

                # åˆ¤æ–· barline é¡å‹ï¼ˆéœ€è¦å°æ‡‰ MusicXMLï¼‰
                class_id = self.infer_barline_class(elem)

                bboxes.append({
                    'class_id': class_id,
                    'x_center': x_center,
                    'y_center': y_center,
                    'width': norm_width,
                    'height': norm_height
                })

        return bboxes

    def infer_barline_class(self, svg_elem):
        """
        æ ¹æ“š SVG å…ƒç´ æ¨æ–· barline é¡åˆ¥
        Verovio å¯èƒ½åœ¨ class å±¬æ€§ä¸­åŒ…å«æ¨£å¼è³‡è¨Š
        """
        classes = svg_elem.get('class', '').lower()

        # Verovio çš„ class å‘½åè¦å‰‡
        if 'double' in classes or 'heavy-light' in classes:
            return 24  # barline_double
        elif 'final' in classes or 'light-heavy' in classes:
            return 25  # barline_final
        elif 'repeat' in classes:
            return 26  # barline_repeat
        else:
            return 23  # barline (regular)

    def batch_render(self, max_files=None, workers=4):
        """æ‰¹é‡æ¸²æŸ“æ‰€æœ‰ç¬¦åˆæ¢ä»¶çš„æ–‡ä»¶"""
        # 1. æ‰¾åˆ°æ‰€æœ‰ MusicXML æ–‡ä»¶
        mxl_files = list(self.openscore_dir.rglob("*.mxl")) + \
                    list(self.openscore_dir.rglob("*.xml"))

        # 2. éæ¿¾ï¼šåªä¿ç•™å« double/final barlines çš„æ–‡ä»¶
        target_files = []
        for mxl in tqdm(mxl_files, desc="Filtering files"):
            if self.has_target_barlines(mxl):
                target_files.append(mxl)

        print(f"âœ… Found {len(target_files)} files with double/final barlines")

        if max_files:
            target_files = target_files[:max_files]

        # 3. æ‰¹é‡æ¸²æŸ“
        results = []
        for mxl in tqdm(target_files, desc="Rendering"):
            try:
                output_name = mxl.stem
                images = self.render_file(mxl, output_name)
                results.append({
                    'source': str(mxl),
                    'images': [str(img) for img in images],
                    'success': True
                })
            except Exception as e:
                results.append({
                    'source': str(mxl),
                    'error': str(e),
                    'success': False
                })

        # 4. ç”Ÿæˆå ±å‘Š
        success_count = sum(1 for r in results if r['success'])
        print(f"\nâœ… Rendered {success_count}/{len(target_files)} files successfully")

        # ä¿å­˜å ±å‘Š
        with open(self.output_dir / "render_report.json", "w") as f:
            json.dump(results, f, indent=2)

        return results

# ä¸»åŸ·è¡Œ
if __name__ == "__main__":
    renderer = OpenScoreBarlineRenderer(
        openscore_dir="/home/thc1006/dev/music-app/training/datasets/external/omr_downloads/OpenScoreLieder",
        output_dir="/home/thc1006/dev/music-app/training/datasets/openscore_barlines_rendered"
    )

    # å…ˆæ¸¬è©¦ 10 å€‹æ–‡ä»¶
    results = renderer.batch_render(max_files=10, workers=1)

    # å¦‚æœæˆåŠŸï¼Œæ¸²æŸ“å…¨éƒ¨
    # results = renderer.batch_render(max_files=None, workers=4)
```

#### Day 2: æ¨™è¨»æå–èˆ‡æ•¸æ“šé›†æ•´åˆï¼ˆ4-6 å°æ™‚ï¼‰

```bash
# Step 1: åŸ·è¡Œæ¸²æŸ“
python scripts/render_openscore_barlines.py

# Step 2: è½‰æ›ç‚º YOLO æ ¼å¼
python scripts/convert_openscore_to_yolo.py

# Step 3: åˆä½µåˆ° Phase 6 æ•¸æ“šé›†
python scripts/merge_openscore_phase7.py
```

### é æœŸæ•ˆæœ

| æŒ‡æ¨™ | Phase 6 | Phase 7 (with OpenScore) | æå‡ |
|------|---------|--------------------------|------|
| **barline_double æ¨™è¨»æ•¸** | ~2,000 | **6,017** | +200% |
| **barline_final æ¨™è¨»æ•¸** | ~5,054 | **8,608** | +70% |
| **é æœŸ mAP50** | 0.180 | **0.35-0.45** | +94-150% |
| **é æœŸå¬å›ç‡** | 19.2% | **40-50%** | +108-160% |

---

## ğŸ”§ æ–¹æ¡ˆ 1B: æ¨™è¨»ä¿®æ­£è…³æœ¬ï¼ˆç«‹å³åŸ·è¡Œï¼‰

### å•é¡Œå®šä½

æ ¹æ“š `BARLINE_COMPLETE_ANALYSIS.txt`:
- **67.8% çš„ barline_double æ¨™è¨»é¢ç© > 0.1**ï¼ˆéåº¦è†¨è„¹ï¼‰
- **å¹³å‡é¢ç©: 0.0751**ï¼ˆæ‡‰è©² â‰¤ 0.03ï¼‰

### ä¿®æ­£ç­–ç•¥

å‰µå»º `scripts/fix_barline_double_annotations.py`:

```python
"""
barline_double æ¨™è¨»ç·Šç¸®è…³æœ¬
å°‡éå¤§çš„æ¨™è¨»æ¡†æ™ºèƒ½ç·Šç¸®åˆ°åˆç†å¤§å°
"""
import cv2
import numpy as np
from pathlib import Path
from tqdm import tqdm
import shutil

def shrink_barline_double_bbox(bbox, target_area=0.03, min_width=0.01):
    """
    æ™ºèƒ½ç·Šç¸® barline_double æ¨™è¨»æ¡†

    ç­–ç•¥:
    1. double barline = 2 æ ¹ç´°ç·š + ä¸­é–“ç©ºéš™
    2. å¯¬åº¦æ‡‰è©²ç´„ç‚º 0.02-0.03 (normalized)
    3. é«˜åº¦ä¿æŒä¸è®Šï¼ˆè·¨è¶Šäº”ç·šè­œï¼‰
    """
    x_center, y_center, width, height = bbox

    current_area = width * height

    if current_area > 0.1:  # éå¤§
        # è¨ˆç®—åˆç†å¯¬åº¦ï¼ˆåŸºæ–¼ target_areaï¼‰
        new_width = target_area / height
        new_width = max(new_width, min_width)  # ç¢ºä¿ä¸æœƒå¤ªç´°

        # ä¿æŒä¸­å¿ƒé»ä¸è®Š
        return [x_center, y_center, new_width, height]

    return bbox  # ä¸éœ€ä¿®æ”¹

def process_label_file(label_path, output_path, stats):
    """è™•ç†å–®å€‹æ¨™è¨»æ–‡ä»¶"""
    with open(label_path, 'r') as f:
        lines = f.readlines()

    modified_lines = []
    for line in lines:
        parts = line.strip().split()
        if len(parts) != 5:
            modified_lines.append(line)
            continue

        class_id = int(parts[0])
        bbox = [float(x) for x in parts[1:]]

        if class_id == 24:  # barline_double
            original_area = bbox[2] * bbox[3]
            new_bbox = shrink_barline_double_bbox(bbox)
            new_area = new_bbox[2] * new_bbox[3]

            if new_area != original_area:
                stats['modified'] += 1
                stats['area_before'].append(original_area)
                stats['area_after'].append(new_area)

            modified_lines.append(f"{class_id} {' '.join(map(str, new_bbox))}\n")
        else:
            modified_lines.append(line)

    # å¯«å…¥ä¿®æ­£å¾Œçš„æ¨™è¨»
    with open(output_path, 'w') as f:
        f.writelines(modified_lines)

def main():
    # è¼¸å…¥/è¼¸å‡ºç›®éŒ„
    input_dataset = Path("datasets/yolo_harmony_v2_phase6_ultimate")
    output_dataset = Path("datasets/yolo_harmony_v2_phase6_double_fixed")

    # å‰µå»ºè¼¸å‡ºç›®éŒ„çµæ§‹
    for split in ['train', 'val']:
        (output_dataset / split / "images").mkdir(parents=True, exist_ok=True)
        (output_dataset / split / "labels").mkdir(parents=True, exist_ok=True)

    stats = {
        'modified': 0,
        'area_before': [],
        'area_after': []
    }

    # è™•ç†è¨“ç·´é›†å’Œé©—è­‰é›†
    for split in ['train', 'val']:
        label_dir = input_dataset / split / "labels"
        image_dir = input_dataset / split / "images"

        output_label_dir = output_dataset / split / "labels"
        output_image_dir = output_dataset / split / "images"

        # è¤‡è£½åœ–ç‰‡ï¼ˆç¬¦è™Ÿé€£çµä»¥ç¯€çœç©ºé–“ï¼‰
        for img in image_dir.glob("*.png"):
            dst = output_image_dir / img.name
            if not dst.exists():
                dst.symlink_to(img.absolute())

        # è™•ç†æ¨™è¨»
        for label_path in tqdm(list(label_dir.glob("*.txt")), desc=f"Processing {split}"):
            output_path = output_label_dir / label_path.name
            process_label_file(label_path, output_path, stats)

    # ç”Ÿæˆå ±å‘Š
    print(f"\n=== barline_double æ¨™è¨»ä¿®æ­£å ±å‘Š ===")
    print(f"ä¿®æ­£æ•¸é‡: {stats['modified']}")
    if stats['area_before']:
        print(f"å¹³å‡é¢ç© (ä¿®æ­£å‰): {np.mean(stats['area_before']):.4f}")
        print(f"å¹³å‡é¢ç© (ä¿®æ­£å¾Œ): {np.mean(stats['area_after']):.4f}")
        print(f"å¹³å‡ç¸®å°æ¯”ä¾‹: {(1 - np.mean(stats['area_after']) / np.mean(stats['area_before'])) * 100:.1f}%")

    # æ›´æ–° data.yaml
    data_yaml_content = f"""# Phase 6 barline_double ä¿®æ­£æ•¸æ“šé›†
path: {output_dataset.absolute()}
train: train/images
val: val/images

nc: 33
names: ['notehead_filled', 'notehead_hollow', 'stem', 'beam', 'flag_8th', 'flag_16th', 'flag_32nd',
        'augmentation_dot', 'accidental_sharp', 'accidental_flat', 'accidental_double_sharp',
        'accidental_double_flat', 'accidental_natural', 'clef_treble', 'clef_bass', 'clef_alto',
        'clef_tenor', 'dynamic_f', 'dynamic_p', 'dynamic_mf', 'dynamic_mp', 'rest_whole', 'rest_half',
        'rest_quarter', 'rest_8th', 'rest_16th', 'barline', 'barline_double', 'barline_final',
        'barline_repeat', 'time_signature', 'key_signature', 'fermata']
"""

    with open(output_dataset / "data.yaml", "w") as f:
        f.write(data_yaml_content)

    print(f"\nâœ… æ•¸æ“šé›†å·²ä¿å­˜åˆ°: {output_dataset}")
    print(f"âœ… ä½¿ç”¨ä»¥ä¸‹é…ç½®è¨“ç·´: {output_dataset / 'data.yaml'}")

if __name__ == "__main__":
    main()
```

### åŸ·è¡Œ

```bash
cd /home/thc1006/dev/music-app/training
python scripts/fix_barline_double_annotations.py
```

### é æœŸæ•ˆæœ

| æŒ‡æ¨™ | ä¿®æ­£å‰ | ä¿®æ­£å¾Œ | æ”¹å–„ |
|------|--------|--------|------|
| **å¹³å‡æ¨™è¨»é¢ç©** | 0.0751 | **0.025-0.035** | -60-70% |
| **éå¤§æ¨™è¨»æ¯”ä¾‹** | 67.8% | **<10%** | -85% |
| **é æœŸ mAP50 æå‡** | - | **+0.05-0.08** | +28-44% |

---

## âš¡ æ–¹æ¡ˆ 2: æ¿€é€²åŠ æ¬Šè¨“ç·´ï¼ˆçŸ­æœŸæ–¹æ¡ˆï¼‰

### ç•¶å‰æ¬Šé‡é…ç½®ï¼ˆPhase 6ï¼‰

```yaml
class_weights:
  23: 4.0   # barline
  24: 8.0   # barline_double
  25: 2.0   # barline_final
  26: 1.0   # barline_repeat

sampling_weights:
  23: 5.0
  24: 8.0
  25: 2.0
  26: 1.5
```

### æ¿€é€²æ–¹æ¡ˆï¼ˆPhase 7ï¼‰

å‰µå»º `configs/phase7_barline_extreme.yaml`:

```yaml
# Phase 7: æ¥µç«¯ barline_double å„ªåŒ–é…ç½®

stage1:
  epochs: 150
  patience: 50
  batch: 16
  imgsz: 640
  lr0: 0.001

  # æ¥µç«¯é¡åˆ¥æ¬Šé‡
  class_weights:
    23: 6.0    # barline (æå‡åˆ° 6x)
    24: 16.0   # barline_double (æå‡åˆ° 16x) âš¡
    25: 2.0    # barline_final
    26: 1.0    # barline_repeat

  # æ¥µç«¯æ¡æ¨£æ¬Šé‡
  sampling_weights:
    23: 8.0
    24: 20.0   # barline_double (æå‡åˆ° 20x) âš¡
    25: 2.0
    26: 1.5

  # æ¿€é€²æå¤±æ¬Šé‡
  box: 10.0    # æå‡ bbox æå¤±æ¬Šé‡
  cls: 4.0     # æå‡åˆ†é¡æå¤±æ¬Šé‡
  dfl: 2.0     # æå‡åˆ†ä½ˆç„¦é»æå¤±

  # æ›´æ¿€é€²çš„å¢å¼·
  mosaic: 1.0
  mixup: 0.2   # æå‡ mixup
  copy_paste: 0.3  # æå‡ copy_pasteï¼ˆå°ˆé–€è¤‡è£½ barline_doubleï¼‰

  # å°ç‰©é«”å„ªåŒ–
  scale: 0.5
  translate: 0.2

# Hard Example Mining é…ç½®
hem:
  confidence_threshold: 0.5
  iou_threshold: 0.5
  target_classes: [23, 24, 25, 26]  # æ‰€æœ‰ barline é¡åˆ¥

  # é›£åº¦è©•åˆ†
  false_negative_score: 3.0  # æå‡ FN æ¬Šé‡
  low_confidence_score: 2.0
  misclassification_score: 2.0

# Stage 2: é›£ä¾‹å¾®èª¿
stage2:
  epochs: 50
  lr0: 0.0005

  class_weights:
    24: 20.0   # barline_double æ¥µç«¯æ¬Šé‡ âš¡

  box: 15.0
  cls: 5.0
  dfl: 2.5
```

### è¨“ç·´è…³æœ¬

```bash
# Phase 7 è¨“ç·´ï¼ˆä½¿ç”¨æ¿€é€²é…ç½®ï¼‰
python custom_training/train_phase7.py \
  --config configs/phase7_barline_extreme.yaml \
  --data datasets/yolo_harmony_v2_phase6_double_fixed/data.yaml \
  --weights harmony_omr_v2_phase6/ultimate_barline_fixed/weights/best.pt
```

### é æœŸæ•ˆæœ

| æŒ‡æ¨™ | Phase 6 | Phase 7 é æœŸ | æå‡ |
|------|---------|-------------|------|
| **mAP50** | 0.180 | **0.28-0.35** | +55-94% |
| **å¬å›ç‡** | 19.2% | **35-45%** | +82-134% |
| **ç²¾ç¢ºç‡** | 42.1% | **55-65%** | +31-54% |

---

## ğŸ—ï¸ æ–¹æ¡ˆ 3: åˆæˆæ•¸æ“šç”Ÿæˆï¼ˆä¸­æœŸæ–¹æ¡ˆï¼‰

### Verovio åˆæˆç³»çµ±ï¼ˆå·²å¯¦æ–½ 90%ï¼‰

æ ¹æ“š `synthetic_generation/README.md`:

**ç•¶å‰ç‹€æ…‹**:
- âœ… MEI ç”Ÿæˆå™¨å®Œæˆ
- âœ… Verovio æ¸²æŸ“å™¨å®Œæˆ
- âš ï¸ **Bbox æå–éœ€è¦ä¿®æ­£**ï¼ˆåº§æ¨™è¶…å‡º [0,1] ç¯„åœï¼‰
- âš ï¸ æˆåŠŸç‡ä½ï¼ˆ10 å¼µä¸­åªæœ‰ 1 å¼µæˆåŠŸï¼‰

### ä¿®æ­£è¨ˆåŠƒï¼ˆ2-3 å¤©ï¼‰

#### Day 1: ä¿®æ­£ Bbox æå–ï¼ˆ6-8 å°æ™‚ï¼‰

```python
# synthetic_generation/src/bbox_extractor_v2.py
"""
ä½¿ç”¨ Verovio åŸç”Ÿ API æå–ç²¾ç¢º bbox
"""
import verovio

class VerovioNativeBboxExtractor:
    def __init__(self, tk: verovio.toolkit):
        self.tk = tk

    def extract_barline_bboxes(self, page=1):
        """
        ä½¿ç”¨ Verovio çš„ getElementsAtTime() API
        æå–ç²¾ç¢ºçš„ barline ä½ç½®
        """
        # Verovio å¯ä»¥è¿”å› SVG ä¸­çš„å…ƒç´ åº§æ¨™
        svg_string = self.tk.renderToSVG(page)

        # è§£æ SVG ç²å–å¯¦éš›åƒç´ åº§æ¨™
        import xml.etree.ElementTree as ET
        root = ET.fromstring(svg_string)

        # SVG viewBox å®šç¾©äº†åº§æ¨™ç³»çµ±
        viewBox = root.get('viewBox')
        vb_parts = viewBox.split()
        svg_width = float(vb_parts[2])
        svg_height = float(vb_parts[3])

        bboxes = []

        # æ‰¾åˆ°æ‰€æœ‰ barline å…ƒç´ 
        # Verovio ä½¿ç”¨ç‰¹å®šçš„ class åç¨±
        for elem in root.iter():
            elem_class = elem.get('class', '')

            if 'barLine' in elem_class:  # Verovio å‘½åè¦å‰‡
                # å–å¾— transform æˆ–ç›´æ¥åº§æ¨™
                x = float(elem.get('x', 0))
                y = float(elem.get('y', 0))
                width = float(elem.get('width', 5))  # barline å¯¬åº¦é€šå¸¸å¾ˆå°
                height = float(elem.get('height', 100))  # è·¨è¶Šäº”ç·šè­œ

                # æ­£ç¢ºçš„ YOLO æ ¼å¼è½‰æ›
                x_center = (x + width / 2) / svg_width
                y_center = (y + height / 2) / svg_height
                norm_width = width / svg_width
                norm_height = height / svg_height

                # ç¢ºä¿åœ¨ [0, 1] ç¯„åœå…§
                x_center = max(0, min(1, x_center))
                y_center = max(0, min(1, y_center))
                norm_width = max(0.001, min(1, norm_width))
                norm_height = max(0.001, min(1, norm_height))

                # æ¨æ–·é¡åˆ¥
                class_id = self.infer_barline_type(elem)

                bboxes.append({
                    'class_id': class_id,
                    'x_center': x_center,
                    'y_center': y_center,
                    'width': norm_width,
                    'height': norm_height
                })

        return bboxes

    def infer_barline_type(self, svg_elem):
        """
        æ ¹æ“š SVG å…ƒç´ çš„ class å±¬æ€§æ¨æ–·é¡å‹
        Verovio æœƒåœ¨ class ä¸­åŒ…å«æ¨£å¼è³‡è¨Š
        """
        classes = svg_elem.get('class', '').lower()

        # Verovio çš„ barline æ¨£å¼
        if 'double' in classes or 'barlinedbl' in classes:
            return 24  # barline_double
        elif 'end' in classes or 'barlineend' in classes:
            return 25  # barline_final
        elif 'rptboth' in classes or 'repeat' in classes:
            return 26  # barline_repeat
        else:
            return 23  # regular barline

# æ¸¬è©¦è…³æœ¬
if __name__ == "__main__":
    tk = verovio.toolkit()
    extractor = VerovioNativeBboxExtractor(tk)

    # æ¸¬è©¦æ–‡ä»¶
    tk.loadFile("test.mei")
    bboxes = extractor.extract_barline_bboxes(page=1)

    print(f"âœ… Extracted {len(bboxes)} barlines")
    for bbox in bboxes:
        print(f"  Class {bbox['class_id']}: x={bbox['x_center']:.3f}, w={bbox['width']:.4f}")
```

#### Day 2-3: æ‰¹é‡ç”Ÿæˆï¼ˆ12-16 å°æ™‚ï¼‰

```bash
# ä¿®æ­£å¾Œé‡æ–°ç”Ÿæˆ
python synthetic_generation/generate_synthetic_barlines.py \
  --num-images 10000 \
  --output-dir datasets/synthetic_barlines_v2 \
  --workers 8 \
  --barline-double-ratio 0.3  # 30% ç‚º double barlines
```

### é æœŸç”¢å‡º

| æŒ‡æ¨™ | æ•¸é‡ |
|------|------|
| **ç¸½åœ–ç‰‡** | 10,000 |
| **barline_double å¯¦ä¾‹** | ~30,000 (3 per image) |
| **å…¶ä»– barlines** | ~70,000 |
| **é æœŸ mAP50 æå‡** | +0.15-0.20 |

---

## ğŸ”€ æ–¹æ¡ˆ 4: é¡åˆ¥åˆä½µï¼ˆå‚™é¸æ–¹æ¡ˆï¼‰

### åˆä½µç­–ç•¥

å°‡ `barline_double` å’Œ `barline_final` åˆä½µç‚ºä¸€å€‹é¡åˆ¥:
- **æ–°é¡åˆ¥**: `barline_thick` (ID 24)
- **ç†ç”±**: è¦–è¦ºä¸Šéƒ½æ˜¯ã€Œç²—/é›™ç·šã€barlineï¼Œåˆ†é¡å›°é›£

### å„ªé»
- âœ… æ¨£æœ¬æ•¸å¢åŠ : 1,883 + 58,819 = **60,702** (32x increase)
- âœ… é™ä½é¡åˆ¥æ··æ·†
- âœ… å¿«é€Ÿè¦‹æ•ˆï¼ˆ2-3 å¤©ï¼‰

### ç¼ºé»
- âŒ å¤±å»ç´°ç²’åº¦åˆ†é¡
- âŒ éœ€è¦é‡æ–°æ¨™è¨»æ•¸æ“šé›†
- âŒ èˆ‡åŸå§‹ç›®æ¨™ä¸ç¬¦ï¼ˆå››éƒ¨å’Œè²éœ€è¦å€åˆ†çµ‚æ­¢ç·šï¼‰

### å¯¦æ–½é›£åº¦
- ä¸­ç­‰ï¼ˆéœ€è¦ä¿®æ”¹æ•¸æ“šé›†æ¨™ç±¤ï¼‰
- ä¼°è¨ˆæ™‚é–“: 2-3 å¤©

---

## ğŸ“Š ç¶œåˆæ”¹å–„æ™‚é–“è¡¨

### Week 1ï¼ˆç«‹å³åŸ·è¡Œï¼‰

**Day 1-2: æ•¸æ“šå¢å¼·èˆ‡ä¿®æ­£**
- [ ] åŸ·è¡Œæ–¹æ¡ˆ 1A: OpenScore Lieder æ¸²æŸ“ï¼ˆå„ªå…ˆ double barlinesï¼‰
- [ ] åŸ·è¡Œæ–¹æ¡ˆ 1B: æ¨™è¨»ä¿®æ­£è…³æœ¬
- [ ] åˆä½µæ•¸æ“šé›†ï¼Œå‰µå»º Phase 7 æ•¸æ“šé›†

**Day 3-4: Phase 7 è¨“ç·´**
- [ ] åŸ·è¡Œæ–¹æ¡ˆ 2: æ¿€é€²åŠ æ¬Šè¨“ç·´
- [ ] ä½¿ç”¨ä¿®æ­£å¾Œçš„æ•¸æ“šé›† + OpenScore æ–°æ•¸æ“š
- [ ] é æœŸè¨“ç·´æ™‚é–“: 6-9 å°æ™‚ (RTX 5090)

**Day 5: è©•ä¼°èˆ‡èª¿æ•´**
- [ ] è©•ä¼° Phase 7 çµæœ
- [ ] åˆ†æ per-class æ€§èƒ½
- [ ] æ±ºå®šæ˜¯å¦éœ€è¦æ–¹æ¡ˆ 3 æˆ– 4

### Week 2-3ï¼ˆå¦‚æœ Week 1 æœªé”æ¨™ï¼‰

**æ–¹æ¡ˆ 3: åˆæˆæ•¸æ“šç”Ÿæˆ**
- [ ] ä¿®æ­£ Verovio bbox æå–
- [ ] ç”Ÿæˆ 10,000 å¼µåˆæˆåœ–ç‰‡
- [ ] åˆä½µåˆ° Phase 8 æ•¸æ“šé›†
- [ ] è¨“ç·´ Phase 8

---

## ğŸ¯ æˆåŠŸæ¨™æº–

### Phase 7 ç›®æ¨™ï¼ˆWeek 1 çµæŸï¼‰

| æŒ‡æ¨™ | ç•¶å‰ | ç›®æ¨™ | æœ€ä½è¦æ±‚ |
|------|------|------|---------|
| **mAP50** | 0.180 | **0.40+** | 0.35 |
| **å¬å›ç‡** | 19.2% | **50%+** | 40% |
| **ç²¾ç¢ºç‡** | 42.1% | **65%+** | 55% |

### Phase 8 ç›®æ¨™ï¼ˆå¦‚éœ€ Week 2-3ï¼‰

| æŒ‡æ¨™ | Phase 7 | ç›®æ¨™ | æœ€ä½è¦æ±‚ |
|------|---------|------|---------|
| **mAP50** | 0.35-0.40 | **0.50+** | 0.45 |
| **å¬å›ç‡** | 40-50% | **60%+** | 55% |
| **ç²¾ç¢ºç‡** | 55-65% | **75%+** | 70% |

---

## ğŸ’¡ é—œéµå»ºè­°

### ç«‹å³è¡Œå‹•ï¼ˆä»Šå¤©/æ˜å¤©ï¼‰

1. **å„ªå…ˆåŸ·è¡Œæ–¹æ¡ˆ 1A**: OpenScore Lieder æ˜¯æœ€å¿«ã€æœ€ç¢ºå®šçš„æ•¸æ“šä¾†æº
   - 463 å€‹ heavy-light barlines å¯ä»¥ç›´æ¥è§£æ±ºæ¨£æœ¬ç¨€å°‘å•é¡Œ
   - 1-2 å¤©å¯å®Œæˆ

2. **ä¸¦è¡ŒåŸ·è¡Œæ–¹æ¡ˆ 1B**: æ¨™è¨»ä¿®æ­£è…³æœ¬åŸ·è¡Œå¿«é€Ÿï¼ˆ4-6 å°æ™‚ï¼‰
   - å¯ä»¥ç«‹å³æ”¹å–„ç¾æœ‰æ•¸æ“šè³ªé‡
   - ç„¡éœ€é¡å¤–æ•¸æ“šæ”¶é›†

3. **æº–å‚™æ–¹æ¡ˆ 2**: ä¿®æ”¹è¨“ç·´é…ç½®æ–‡ä»¶
   - å¯ä»¥åœ¨ç­‰å¾…æ•¸æ“šç”Ÿæˆæ™‚ä¸¦è¡Œæº–å‚™
   - é…ç½®æ–‡ä»¶ä¿®æ”¹åªéœ€ 1 å°æ™‚

### ä¸­æœŸè¨ˆåŠƒï¼ˆ1-2 é€±ï¼‰

- **å¦‚æœ Phase 7 é”åˆ° mAP50 0.35+**: å¯ä»¥è€ƒæ…®ç›´æ¥é€²å…¥ç”Ÿç”¢éƒ¨ç½²æ¸¬è©¦
- **å¦‚æœ Phase 7 æœªé”æ¨™**: åŸ·è¡Œæ–¹æ¡ˆ 3ï¼ˆåˆæˆæ•¸æ“šç”Ÿæˆï¼‰
- **æ–¹æ¡ˆ 4ï¼ˆé¡åˆ¥åˆä½µï¼‰**: åƒ…ä½œç‚ºæœ€å¾Œæ‰‹æ®µ

### ç›£æ§æŒ‡æ¨™

è¨“ç·´éç¨‹ä¸­é‡é»ç›£æ§:
- âœ… barline_double å¬å›ç‡ > 40%ï¼ˆé—œéµæŒ‡æ¨™ï¼‰
- âœ… False Negative æ•¸é‡ä¸‹é™
- âœ… Confusion matrix: barline_double ä¸å†èˆ‡ barline_final æ··æ·†
- âœ… Loss æ›²ç·š: cls_loss ä¸‹é™ï¼ˆç•¶å‰ 2.77ï¼Œç›®æ¨™ < 2.0ï¼‰

---

## ğŸ“‚ ç›¸é—œæ–‡æª”

- `BARLINE_COMPLETE_ANALYSIS.txt` - æ ¹æœ¬åŸå› åˆ†æ
- `OPENSCORE_LIEDER_ANALYSIS.md` - å¤–éƒ¨æ•¸æ“šæºåˆ†æ
- `PHASE6_IMPLEMENTATION_SUMMARY.md` - ç•¶å‰å¯¦æ–½ç‹€æ…‹
- `SYNTHETIC_DATA_SUMMARY.md` - åˆæˆæ•¸æ“šç ”ç©¶
- `synthetic_generation/README.md` - åˆæˆç³»çµ±æ–‡æª”

---

## ğŸ“ æ±ºç­–é»

### éœ€è¦ç¢ºèªçš„å•é¡Œ

1. **æ˜¯å¦ç«‹å³é–‹å§‹ OpenScore æ¸²æŸ“ï¼Ÿ**
   - æ¨è–¦: âœ… æ˜¯ï¼ˆæœ€é«˜ ROIï¼‰
   - é æœŸæ™‚é–“: 1-2 å¤©

2. **æ˜¯å¦åŸ·è¡Œæ¨™è¨»ä¿®æ­£è…³æœ¬ï¼Ÿ**
   - æ¨è–¦: âœ… æ˜¯ï¼ˆå¿«é€Ÿè¦‹æ•ˆï¼‰
   - é æœŸæ™‚é–“: 4-6 å°æ™‚

3. **æ˜¯å¦ä½¿ç”¨æ¿€é€²åŠ æ¬Šé…ç½®ï¼Ÿ**
   - æ¨è–¦: âœ… æ˜¯ï¼ˆé¢¨éšªå¯æ§ï¼‰
   - é æœŸæ™‚é–“: 8-12 å°æ™‚è¨“ç·´

4. **å¦‚æœ Week 1 æœªé”æ¨™ï¼Œæ˜¯å¦é€²å…¥ Week 2-3 è¨ˆåŠƒï¼Ÿ**
   - æ¨è–¦: è¦– Phase 7 çµæœæ±ºå®š
   - å‚™é¸: åˆæˆæ•¸æ“šç”Ÿæˆæˆ–é¡åˆ¥åˆä½µ

---

**ç¸½çµ**: å»ºè­°æ¡ç”¨**é›™ç®¡é½Šä¸‹ç­–ç•¥**ï¼š
1. **çŸ­æœŸï¼ˆ1-2 å¤©ï¼‰**: æ–¹æ¡ˆ 1A + 1Bï¼ˆæ•¸æ“šå¢å¼· + ä¿®æ­£ï¼‰
2. **ä¸­æœŸï¼ˆ3-5 å¤©ï¼‰**: æ–¹æ¡ˆ 2ï¼ˆæ¿€é€²è¨“ç·´ï¼‰+ è©•ä¼°
3. **å‚™ç”¨ï¼ˆ1-2 é€±ï¼‰**: æ–¹æ¡ˆ 3ï¼ˆåˆæˆæ•¸æ“šï¼‰æˆ– æ–¹æ¡ˆ 4ï¼ˆé¡åˆ¥åˆä½µï¼‰

é æœŸç¶“é Week 1 çš„åŠªåŠ›ï¼Œbarline_double mAP50 å¯å¾ 0.180 æå‡è‡³ **0.35-0.45**ï¼Œå¬å›ç‡å¾ 19.2% æå‡è‡³ **40-50%**ï¼Œé”åˆ°å¯ç”¨æ°´å¹³ã€‚
